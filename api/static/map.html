<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта фотографий - Smart Photo Search</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Toolbar */
        .toolbar {
            padding: 12px 20px;
            background: #16213e;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-label {
            color: #888;
            font-size: 13px;
        }

        input[type="date"] {
            padding: 8px 12px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            background: #0f3460;
            color: #fff;
            outline: none;
        }

        input[type="date"]:focus {
            box-shadow: 0 0 0 2px #e94560;
        }

        .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-primary:hover {
            background: #ff6b6b;
        }

        .btn-secondary {
            background: #0f3460;
            color: #aaa;
        }

        .btn-secondary:hover {
            background: #1a4a7a;
            color: #fff;
        }

        .nav-link {
            color: #888;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: #fff;
            background: #0f3460;
        }

        /* Stats panel */
        .stats-panel {
            background: #0f3460;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: #aaa;
        }

        .stats-panel strong {
            color: #e94560;
        }

        /* Map container */
        #map {
            flex: 1;
            width: 100%;
        }

        /* Custom cluster markers */
        .cluster-marker {
            background: #e94560;
            border: 3px solid #fff;
            border-radius: 50%;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .cluster-marker:hover {
            transform: scale(1.1);
        }

        .cluster-small {
            width: 36px;
            height: 36px;
            font-size: 12px;
        }

        .cluster-medium {
            width: 46px;
            height: 46px;
            font-size: 14px;
        }

        .cluster-large {
            width: 56px;
            height: 56px;
            font-size: 16px;
        }

        .cluster-huge {
            width: 66px;
            height: 66px;
            font-size: 18px;
            background: #ff6b6b;
        }

        /* Popup styles */
        .leaflet-popup-content-wrapper {
            background: #16213e;
            color: #fff;
            border-radius: 8px;
        }

        .leaflet-popup-content {
            margin: 12px;
        }

        .leaflet-popup-tip {
            background: #16213e;
        }

        .popup-content {
            min-width: 200px;
        }

        .popup-content h3 {
            margin-bottom: 8px;
            color: #e94560;
        }

        .popup-content p {
            margin: 4px 0;
            font-size: 13px;
            color: #aaa;
        }

        .popup-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #e94560;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .popup-btn:hover {
            background: #ff6b6b;
        }

        /* Loading overlay */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(22, 33, 62, 0.95);
            padding: 20px 40px;
            border-radius: 12px;
            z-index: 2000;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #0f3460;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Fullscreen button */
        .btn-fullscreen {
            background: #0f3460;
            color: #aaa;
            padding: 10px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-fullscreen:hover {
            background: #1a4a7a;
            color: #fff;
        }

        .btn-fullscreen svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Exit fullscreen button (floating) */
        .exit-fullscreen-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 3000;
            background: rgba(22, 33, 62, 0.9);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .exit-fullscreen-btn:hover {
            background: #e94560;
        }

        .exit-fullscreen-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Fullscreen mode (native API) */
        body:fullscreen .toolbar,
        body:-webkit-full-screen .toolbar,
        body:-moz-full-screen .toolbar {
            display: none;
        }

        body:fullscreen .exit-fullscreen-btn,
        body:-webkit-full-screen .exit-fullscreen-btn,
        body:-moz-full-screen .exit-fullscreen-btn {
            display: block;
        }

        body:fullscreen #map,
        body:-webkit-full-screen #map,
        body:-moz-full-screen #map {
            height: 100vh;
        }

        /* iOS fallback - pseudo fullscreen mode */
        body.ios-fullscreen .toolbar {
            display: none;
        }

        body.ios-fullscreen .exit-fullscreen-btn {
            display: block;
        }

        body.ios-fullscreen #map {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2500;
        }

        /* Layer control styling */
        .leaflet-control-layers {
            background: rgba(40, 40, 40, 0.95);
            border: 1px solid #555;
            border-radius: 4px;
        }

        .leaflet-control-layers-toggle {
            background-color: rgba(40, 40, 40, 0.95);
            background-size: 20px 20px;
        }

        .leaflet-control-layers-expanded {
            color: #fff;
            background: rgba(40, 40, 40, 0.95);
            padding: 10px;
        }

        .leaflet-control-layers-base label {
            color: #fff;
        }

        .leaflet-control-layers-separator {
            border-top: 1px solid #555;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .toolbar {
                padding: 10px;
                gap: 10px;
            }

            .stats-panel {
                order: -1;
                width: 100%;
            }

            /* Make fullscreen button more prominent on mobile */
            .btn-fullscreen {
                background: #e94560;
                color: white;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <a href="/" class="nav-link">Поиск</a>
        <a href="/map.html" class="nav-link" style="color: #e94560;">Карта</a>

        <div class="toolbar-section">
            <span class="toolbar-label">С:</span>
            <input type="date" id="dateFrom">
        </div>

        <div class="toolbar-section">
            <span class="toolbar-label">По:</span>
            <input type="date" id="dateTo">
        </div>

        <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
        <button class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>

        <button class="btn btn-fullscreen" onclick="toggleFullscreen()" title="На весь экран">
            <svg viewBox="0 0 24 24">
                <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
        </button>

        <div class="stats-panel" id="statsPanel">
            Загрузка статистики...
        </div>
    </div>

    <div id="map"></div>

    <!-- Exit fullscreen button (shown only in fullscreen mode) -->
    <button class="exit-fullscreen-btn" onclick="exitFullscreen()" title="Выйти из полноэкранного режима">
        <svg viewBox="0 0 24 24">
            <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
        </svg>
    </button>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Загрузка кластеров...</div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Map state
        let map;
        let clusterLayer;
        let currentClusters = [];
        let dateFrom = null;
        let dateTo = null;

        // Parse URL parameters for initial view
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                center_lat: params.get('center_lat') ? parseFloat(params.get('center_lat')) : null,
                center_lon: params.get('center_lon') ? parseFloat(params.get('center_lon')) : null,
                zoom: params.get('zoom') ? parseInt(params.get('zoom')) : null
            };
        }

        // Initialize map
        function initMap() {
            const urlParams = parseUrlParams();
            const initialCenter = (urlParams.center_lat && urlParams.center_lon)
                ? [urlParams.center_lat, urlParams.center_lon]
                : [20, 0];
            const initialZoom = urlParams.zoom || 2;

            map = L.map('map', {
                center: initialCenter,
                zoom: initialZoom,
                minZoom: 2,
                maxZoom: 18
            });

            // Define base layers
            const standardLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            });

            const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
                maxZoom: 17
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 18
            });

            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            });

            // Add default standard layer
            standardLayer.addTo(map);

            // Layer control
            const baseLayers = {
                "Стандартный": standardLayer,
                "Топографический": topoLayer,
                "Спутник": satelliteLayer,
                "Темный": darkLayer
            };

            L.control.layers(baseLayers).addTo(map);

            // Create layer for clusters
            clusterLayer = L.layerGroup().addTo(map);

            // Load clusters on map move
            map.on('moveend', loadClusters);
            map.on('zoomend', loadClusters);

            // Initial load
            loadStats(!urlParams.center_lat); // Don't fit bounds if center was specified
            loadClusters();
        }

        // Load map stats
        async function loadStats(fitBoundsIfAvailable = true) {
            try {
                const response = await fetch('/map/stats');
                const data = await response.json();

                const statsHtml = `
                    <strong>${data.with_gps.toLocaleString()}</strong> фото с GPS
                    (${data.gps_percentage}% из ${data.total_photos.toLocaleString()})
                `;
                document.getElementById('statsPanel').innerHTML = statsHtml;

                // Set default date range if available
                if (data.date_range.min && data.date_range.max) {
                    document.getElementById('dateFrom').min = data.date_range.min.split('T')[0];
                    document.getElementById('dateTo').max = data.date_range.max.split('T')[0];
                }

                // Fit map to data bounds if available and not overridden by URL params
                if (fitBoundsIfAvailable && data.geo_bounds.min_lat !== null) {
                    const bounds = [
                        [data.geo_bounds.min_lat, data.geo_bounds.min_lon],
                        [data.geo_bounds.max_lat, data.geo_bounds.max_lon]
                    ];
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('statsPanel').innerHTML = 'Ошибка загрузки статистики';
            }
        }

        // Load clusters for current viewport
        async function loadClusters() {
            const bounds = map.getBounds();
            const zoom = map.getZoom();

            showLoading(true);

            try {
                const response = await fetch('/map/clusters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        min_lat: bounds.getSouth(),
                        max_lat: bounds.getNorth(),
                        min_lon: bounds.getWest(),
                        max_lon: bounds.getEast(),
                        zoom: zoom,
                        date_from: dateFrom,
                        date_to: dateTo
                    })
                });

                const data = await response.json();
                displayClusters(data.clusters);

            } catch (error) {
                console.error('Error loading clusters:', error);
            } finally {
                showLoading(false);
            }
        }

        // Display clusters on map
        function displayClusters(clusters) {
            clusterLayer.clearLayers();
            currentClusters = clusters;

            clusters.forEach(cluster => {
                const marker = createClusterMarker(cluster);
                clusterLayer.addLayer(marker);
            });
        }

        // Create cluster marker
        function createClusterMarker(cluster) {
            // Determine marker size based on count
            let sizeClass = 'cluster-small';
            let size = 36;

            if (cluster.count >= 1000) {
                sizeClass = 'cluster-huge';
                size = 66;
            } else if (cluster.count >= 100) {
                sizeClass = 'cluster-large';
                size = 56;
            } else if (cluster.count >= 10) {
                sizeClass = 'cluster-medium';
                size = 46;
            }

            // Format count
            let countText = cluster.count;
            if (cluster.count >= 1000) {
                countText = Math.round(cluster.count / 1000) + 'k';
            }

            // Create custom icon
            const icon = L.divIcon({
                className: '',
                html: `<div class="cluster-marker ${sizeClass}">${countText}</div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2]
            });

            const marker = L.marker([cluster.latitude, cluster.longitude], { icon });

            // Click handler - always open photos
            marker.on('click', () => {
                openClusterPhotos(cluster);
            });

            // Popup on hover (mouseover)
            const popupContent = `
                <div class="popup-content">
                    <h3>${cluster.count} фото</h3>
                    <p>Широта: ${cluster.latitude.toFixed(4)}</p>
                    <p>Долгота: ${cluster.longitude.toFixed(4)}</p>
                </div>
            `;
            marker.bindPopup(popupContent, { closeButton: false });

            marker.on('mouseover', function() {
                this.openPopup();
            });
            marker.on('mouseout', function() {
                this.closePopup();
            });

            return marker;
        }

        // Open photos in new tab
        function openClusterPhotos(cluster) {
            // Build URL with geo bounds and date filters
            const params = new URLSearchParams();
            params.set('min_lat', cluster.min_lat);
            params.set('max_lat', cluster.max_lat);
            params.set('min_lon', cluster.min_lon);
            params.set('max_lon', cluster.max_lon);

            if (dateFrom) params.set('date_from', dateFrom);
            if (dateTo) params.set('date_to', dateTo);

            // Open results page in new tab
            window.open(`/results.html?${params.toString()}`, '_blank');
        }

        // Apply date filters
        function applyFilters() {
            dateFrom = document.getElementById('dateFrom').value || null;
            dateTo = document.getElementById('dateTo').value || null;
            loadClusters();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            dateFrom = null;
            dateTo = null;
            loadClusters();
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        // Detect iOS (iPhone, iPad, iPod)
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // Check if native fullscreen API is available
        function hasFullscreenAPI() {
            return document.documentElement.requestFullscreen ||
                   document.documentElement.webkitRequestFullscreen ||
                   document.documentElement.mozRequestFullScreen;
        }

        // Toggle fullscreen mode
        function toggleFullscreen() {
            // iOS doesn't support Fullscreen API - use CSS fallback
            if (isIOS() || !hasFullscreenAPI()) {
                document.body.classList.toggle('ios-fullscreen');
                setTimeout(() => map && map.invalidateSize(), 100);
                return;
            }

            if (!document.fullscreenElement &&
                !document.webkitFullscreenElement &&
                !document.mozFullScreenElement) {
                // Enter fullscreen
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                }
            } else {
                exitFullscreen();
            }
        }

        // Exit fullscreen mode
        function exitFullscreen() {
            // iOS fallback
            if (document.body.classList.contains('ios-fullscreen')) {
                document.body.classList.remove('ios-fullscreen');
                setTimeout(() => map && map.invalidateSize(), 100);
                return;
            }

            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }
        }

        // Handle fullscreen change - invalidate map size
        document.addEventListener('fullscreenchange', () => {
            setTimeout(() => map && map.invalidateSize(), 100);
        });
        document.addEventListener('webkitfullscreenchange', () => {
            setTimeout(() => map && map.invalidateSize(), 100);
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
