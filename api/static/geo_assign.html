<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS –ü—Ä–∏–≤—è–∑–∫–∞ - Smart Photo Search</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            padding: 12px 20px;
            background: #16213e;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            flex-shrink: 0;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-label {
            color: #888;
            font-size: 13px;
        }

        .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #ff6b6b;
        }

        .btn-secondary {
            background: #0f3460;
            color: #aaa;
        }

        .btn-secondary:hover {
            background: #1a4a7a;
            color: #fff;
        }

        .btn-secondary.active {
            background: #4ade80;
            color: #000;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #34d399;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-link {
            color: #888;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: #fff;
            background: #0f3460;
        }

        /* Format filters */
        .filters {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .filter-label {
            color: #888;
            font-size: 13px;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #aaa;
        }

        .filter-checkbox input {
            accent-color: #e94560;
            width: 15px;
            height: 15px;
            cursor: pointer;
        }

        .filter-checkbox:hover {
            color: #fff;
        }

        /* Stats panel */
        .stats-panel {
            background: #0f3460;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: #aaa;
        }

        .stats-panel strong {
            color: #e94560;
        }

        /* Main layout - 4 parts */
        .main-container {
            flex: 1;
            display: grid;
            grid-template-rows: 1fr 1fr;
            grid-template-columns: 350px 1fr;
            gap: 2px;
            background: #0f0f1a;
            overflow: hidden;
        }

        /* Folder list panel */
        .folder-panel {
            background: #16213e;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            background: #0f3460;
            font-weight: 600;
            font-size: 14px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
            flex-shrink: 0;
        }

        .panel-header .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .panel-header .count {
            color: #e94560;
            font-size: 12px;
        }

        .panel-header .header-center {
            display: none;
            font-size: 12px;
            font-weight: normal;
            color: #aaa;
            overflow: hidden;
        }

        .panel-header .header-center.visible {
            display: block;
        }

        .panel-header .info-item {
            display: inline;
            margin-right: 20px;
        }

        .panel-header .info-label {
            color: #888;
            margin-right: 4px;
        }

        .panel-header .info-value {
            color: #4ade80;
            font-family: monospace;
        }

        .panel-header .info-path {
            color: #fbbf24;
            word-break: break-all;
        }

        .panel-header .header-right {
            color: #666;
            font-size: 12px;
            font-weight: normal;
            white-space: nowrap;
        }

        .folder-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .folder-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            background: #0f3460;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .folder-item:hover {
            background: #1a4a7a;
        }

        .folder-item.selected {
            background: #e94560;
            color: white;
        }

        .folder-item .folder-path {
            font-size: 12px;
            word-break: break-all;
            flex: 1;
        }

        .folder-item .folder-count {
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .folder-item.selected .folder-count {
            background: rgba(255,255,255,0.3);
        }

        /* Map panel */
        .map-panel {
            background: #16213e;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .map-info {
            padding: 8px 16px;
            background: #0f3460;
            font-size: 12px;
            color: #aaa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .map-info .coords {
            color: #4ade80;
            font-family: monospace;
        }

        /* Photos panel - spans both columns */
        .photos-panel {
            grid-column: 1 / -1;
            background: #16213e;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .photos-grid {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fill, 120px);
            grid-auto-rows: 120px;
            gap: 8px;
            align-content: start;
            justify-content: start;
        }

        .photo-card {
            width: 120px;
            height: 120px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .photo-card.selected {
            box-shadow: 0 0 0 3px #4ade80;
        }

        .photo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-card .checkbox {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #fff;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #000;
        }

        .select-mode .photo-card .checkbox {
            display: flex;
        }

        .photo-card.selected .checkbox {
            background: #4ade80;
            border-color: #4ade80;
        }

        .photo-card.selected .checkbox::after {
            content: "‚úì";
        }

        .photo-card .format-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 9px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #0f3460;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Selection info */
        .selection-info {
            color: #4ade80;
            font-weight: bold;
            font-size: 13px;
        }

        /* Leaflet popup */
        .leaflet-popup-content-wrapper {
            background: #16213e;
            color: #fff;
            border-radius: 8px;
        }

        .leaflet-popup-tip {
            background: #16213e;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 9999;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #ef4444;
        }

        /* Confirm dialog */
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .confirm-dialog.active {
            display: flex;
        }

        .confirm-box {
            background: #16213e;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .confirm-box h3 {
            margin-bottom: 15px;
            color: #e94560;
        }

        .confirm-box p {
            margin-bottom: 20px;
            color: #aaa;
        }

        .confirm-box .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-danger {
            background: #dc2626;
            color: #fff;
        }

        .btn-danger:hover:not(:disabled) {
            background: #ef4444;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 300px 1fr;
            }

            .folder-panel {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-section">
            <a href="/" class="nav-link">–ü–æ–∏—Å–∫</a>
            <a href="/map.html" class="nav-link">–ö–∞—Ä—Ç–∞</a>
            <span class="nav-link" style="color: #e94560; cursor: default;">GPS –ü—Ä–∏–≤—è–∑–∫–∞</span>
        </div>

        <div class="filters">
            <span class="filter-label">–§–æ—Ä–º–∞—Ç—ã:</span>
            <label class="filter-checkbox">
                <input type="checkbox" id="filterAll" checked>
                –í—Å–µ
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" class="format-filter" value="jpg,jpeg" checked>
                JPG
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" class="format-filter" value="heic,heif" checked>
                HEIC
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" class="format-filter" value="png" checked>
                PNG
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" class="format-filter" value="nef" checked>
                NEF
            </label>
        </div>

        <div class="toolbar-section">
            <button id="selectBtn" class="btn btn-secondary">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <span id="selectionInfo" class="selection-info" style="display: none;">0 –≤—ã–±—Ä–∞–Ω–æ</span>
            <button id="deleteBtn" class="btn btn-danger" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>

        <div class="toolbar-section">
            <button id="assignBtn" class="btn btn-success" disabled>
                –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            </button>
            <button id="assignVisibleBtn" class="btn btn-primary" disabled style="margin-left: 10px;">
                –ü—Ä–∏–≤—è–∑–∞—Ç—å –≤–∏–¥–∏–º—ã–µ
            </button>
        </div>

        <div class="toolbar-section" style="margin-left: auto;">
            <div class="stats-panel">
                –ë–µ–∑ GPS: <strong id="statsWithoutGps">-</strong> / <span id="statsTotal">-</span>
            </div>
        </div>
    </div>

    <!-- Main 4-part layout -->
    <div class="main-container">
        <!-- Folder list -->
        <div class="folder-panel">
            <div class="panel-header">
                –ü–∞–ø–∫–∏ –±–µ–∑ GPS
                <span class="count" id="folderCount">0</span>
            </div>
            <div class="folder-list" id="folderList">
                <div class="loading">
                    <div class="spinner"></div>
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-panel">
            <div class="panel-header">
                –ö–∞—Ä—Ç–∞ - –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏
            </div>
            <div id="map"></div>
            <div class="map-info">
                <span>–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞:</span>
                <span class="coords" id="selectedCoords">–Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
            </div>
        </div>

        <!-- Photos grid -->
        <div class="photos-panel">
            <div class="panel-header">
                <div class="header-left">
                    –§–æ—Ç–æ –±–µ–∑ GPS
                    <span class="count" id="photoCount">(0)</span>
                </div>
                <div class="header-center" id="photoInfoHeader">
                    <span class="info-item">
                        <span class="info-label">ID:</span><span class="info-value" id="photoInfoId">-</span>
                    </span>
                    <span class="info-item">
                        <span class="info-label">–†–∞–∑–º–µ—Ä:</span><span class="info-value" id="photoInfoSize">-</span>
                    </span>
                    <span class="info-item">
                        <span class="info-label">–ü—É—Ç—å:</span><span class="info-path" id="photoInfoPath">-</span>
                    </span>
                </div>
                <div class="header-right" id="photoInfoRight">
                    <!-- –†–µ–∑–µ—Ä–≤ -->
                </div>
            </div>
            <div class="photos-grid" id="photosGrid">
                <div class="empty-state">
                    <div class="icon">üìÅ</div>
                    –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å–ª–µ–≤–∞
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <!-- Confirm delete dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-box">
            <h3>–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã?</h3>
            <p id="confirmText">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É.</p>
            <div class="buttons">
                <button id="confirmCancel" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirmDelete" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // State
        let selectedFolder = null;
        let selectedFolderCount = 0;
        let selectedCoords = null;
        let selectedPhotos = new Set();
        let selectMode = false;
        let photos = [];
        let currentFilteredPhotos = []; // –î–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–≤—è–∑–∞—Ç—å –≤–∏–¥–∏–º—ã–µ"
        let marker = null;
        let allFolders = [];  // All folders from API
        let selectedFormats = null;  // null = all formats

        // Elements
        const folderList = document.getElementById('folderList');
        const photosGrid = document.getElementById('photosGrid');
        const selectBtn = document.getElementById('selectBtn');
        const assignBtn = document.getElementById('assignBtn');
        const assignVisibleBtn = document.getElementById('assignVisibleBtn');
        const selectionInfo = document.getElementById('selectionInfo');
        const selectedCoordsEl = document.getElementById('selectedCoords');
        const filterAll = document.getElementById('filterAll');
        const formatFilters = document.querySelectorAll('.format-filter');
        const deleteBtn = document.getElementById('deleteBtn');
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmText = document.getElementById('confirmText');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');

        // Get allowed formats from checkboxes
        function getAllowedFormats() {
            const formats = [];
            formatFilters.forEach(f => {
                if (f.checked) {
                    formats.push(...f.value.split(','));
                }
            });
            return formats;
        }

        // Filter folders by format
        async function filterFoldersByFormat() {
            const formats = getAllowedFormats();
            const allSelected = [...formatFilters].every(f => f.checked);
            selectedFormats = allSelected ? null : formats;

            // Reload folders from API with new filter
            await loadFolders();

            // Re-render photos if folder is selected
            if (selectedFolder && photos.length > 0) {
                renderPhotos();
            }
        }

        // Initialize format filters
        function initFilters() {
            // Filter "All" checkbox logic
            filterAll.addEventListener('change', () => {
                formatFilters.forEach(f => f.checked = filterAll.checked);
                filterFoldersByFormat();
            });

            // Individual format checkbox change
            formatFilters.forEach(f => {
                f.addEventListener('change', () => {
                    const allChecked = [...formatFilters].every(f => f.checked);
                    const noneChecked = [...formatFilters].every(f => !f.checked);
                    filterAll.checked = allChecked;
                    filterAll.indeterminate = !allChecked && !noneChecked;
                    filterFoldersByFormat();
                });
            });
        }

        // Initialize map
        const map = L.map('map').setView([50, 10], 4);

        // Base layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri'
        });

        osmLayer.addTo(map);

        L.control.layers({
            'OpenStreetMap': osmLayer,
            '–°–ø—É—Ç–Ω–∏–∫': satelliteLayer
        }).addTo(map);

        // Map click handler
        map.on('click', function(e) {
            selectedCoords = {
                lat: e.latlng.lat,
                lng: e.latlng.lng
            };

            // Update or create marker
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng, {
                    draggable: true
                }).addTo(map);

                marker.on('dragend', function(e) {
                    selectedCoords = {
                        lat: e.target.getLatLng().lat,
                        lng: e.target.getLatLng().lng
                    };
                    updateCoordsDisplay();
                    updateAssignButton();
                });
            }

            updateCoordsDisplay();
            updateAssignButton();
        });

        function updateCoordsDisplay() {
            if (selectedCoords) {
                selectedCoordsEl.textContent = `${selectedCoords.lat.toFixed(6)}, ${selectedCoords.lng.toFixed(6)}`;
            } else {
                selectedCoordsEl.textContent = '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/geo/stats');
                const data = await response.json();
                document.getElementById('statsWithoutGps').textContent = data.without_gps;
                document.getElementById('statsTotal').textContent = data.total_photos;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load folders
        async function loadFolders() {
            folderList.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                let url = '/geo/folders';
                if (selectedFormats && selectedFormats.length > 0) {
                    url += `?formats=${encodeURIComponent(selectedFormats.join(','))}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                allFolders = data.folders;
                renderFolders();

            } catch (error) {
                console.error('Error loading folders:', error);
                folderList.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        // Render folders (filtering is done server-side)
        function renderFolders() {
            document.getElementById('folderCount').textContent = allFolders.length;

            if (allFolders.length === 0) {
                folderList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        ${selectedFormats ? '–ù–µ—Ç —Ñ–æ—Ç–æ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –±–µ–∑ GPS' : '–í—Å–µ —Ñ–æ—Ç–æ –∏–º–µ—é—Ç GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã'}
                    </div>
                `;
                return;
            }

            folderList.innerHTML = allFolders.map(folder => `
                <div class="folder-item ${selectedFolder === folder.path ? 'selected' : ''}" data-path="${escapeHtml(folder.path)}">
                    <span class="folder-path">${getShortPath(folder.path)}</span>
                    <span class="folder-count">${folder.count}</span>
                </div>
            `).join('');

            // Attach click handlers
            folderList.querySelectorAll('.folder-item').forEach(item => {
                item.addEventListener('click', () => selectFolder(item.dataset.path));
            });
        }

        function getShortPath(fullPath) {
            // Remove common prefix like /photos/
            const parts = fullPath.split('/');
            if (parts.length > 3) {
                return '.../' + parts.slice(-3).join('/');
            }
            return fullPath;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Select folder
        async function selectFolder(path) {
            selectedFolder = path;
            const folderMeta = allFolders.find(f => f.path === path);
            selectedFolderCount = folderMeta ? folderMeta.count : 0;
            selectedPhotos.clear();
            updateSelectionInfo();

            // Hide photo info when changing folder
            document.getElementById('photoInfoHeader').classList.remove('visible');

            // Update UI
            folderList.querySelectorAll('.folder-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.path === path);
            });

            // Load photos
            await loadPhotos(path);
            updateAssignButton();
        }

        // Load photos for folder
        async function loadPhotos(folder) {
            photosGrid.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                let url = `/geo/photos?folder=${encodeURIComponent(folder)}&limit=500`;
                if (selectedFormats && selectedFormats.length > 0) {
                    url += `&formats=${encodeURIComponent(selectedFormats.join(','))}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                photos = data.photos;
                renderPhotos();

            } catch (error) {
                console.error('Error loading photos:', error);
                photosGrid.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        function renderPhotos() {
            // Filter photos by selected formats (client-side backup filter)
            let filteredPhotos = photos;
            if (selectedFormats && selectedFormats.length > 0) {
                filteredPhotos = photos.filter(photo => {
                    const ext = (photo.file_format || photo.file_name.split('.').pop() || '').toLowerCase();
                    return selectedFormats.some(f => f.toLowerCase() === ext);
                });
            }

            currentFilteredPhotos = filteredPhotos; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–≤—è–∑–∞—Ç—å –≤–∏–¥–∏–º—ã–µ"
            document.getElementById('photoCount').textContent = `(${filteredPhotos.length})`;
            updateAssignButton(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞

            if (filteredPhotos.length === 0) {
                photosGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì∑</div>
                        –ù–µ—Ç —Ñ–æ—Ç–æ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏
                    </div>
                `;
                return;
            }

            photosGrid.innerHTML = filteredPhotos.map(photo => `
                <div class="photo-card ${selectedPhotos.has(photo.image_id) ? 'selected' : ''}"
                     data-id="${photo.image_id}"
                     data-path="${escapeHtml(photo.file_path)}"
                     data-size="${photo.file_size || 0}">
                    <img src="/image/${photo.image_id}/thumb" alt="${escapeHtml(photo.file_name)}" loading="lazy">
                    <div class="checkbox"></div>
                    <div class="format-badge">${photo.file_format || 'jpg'}</div>
                </div>
            `).join('');

            // Attach click handlers
            photosGrid.querySelectorAll('.photo-card').forEach(card => {
                card.addEventListener('click', () => {
                    const imageId = parseInt(card.dataset.id);
                    if (selectMode) {
                        togglePhotoSelection(imageId);
                    }
                    // Always show photo info on click
                    showPhotoInfo(imageId, card.dataset.path, parseInt(card.dataset.size));
                });
            });
        }

        // Show photo info in header center section
        function showPhotoInfo(imageId, filePath, fileSize) {
            const photoInfoHeader = document.getElementById('photoInfoHeader');
            const photoInfoId = document.getElementById('photoInfoId');
            const photoInfoSize = document.getElementById('photoInfoSize');
            const photoInfoPath = document.getElementById('photoInfoPath');

            photoInfoId.textContent = imageId;
            photoInfoSize.textContent = formatFileSize(fileSize);
            photoInfoPath.textContent = filePath;

            photoInfoHeader.classList.add('visible');
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '-';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }

        // Toggle select mode
        selectBtn.addEventListener('click', () => {
            selectMode = !selectMode;
            selectBtn.classList.toggle('active', selectMode);
            selectBtn.textContent = selectMode ? '–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä' : '–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ';
            photosGrid.parentElement.classList.toggle('select-mode', selectMode);

            if (!selectMode) {
                selectedPhotos.clear();
                updateSelectionInfo();
                renderPhotos();
                updateAssignButton();
            }
        });

        function togglePhotoSelection(imageId) {
            if (selectedPhotos.has(imageId)) {
                selectedPhotos.delete(imageId);
            } else {
                selectedPhotos.add(imageId);
            }

            // Update UI
            const card = photosGrid.querySelector(`[data-id="${imageId}"]`);
            if (card) {
                card.classList.toggle('selected', selectedPhotos.has(imageId));
            }

            updateSelectionInfo();
            updateAssignButton();
        }

        function updateSelectionInfo() {
            const count = selectedPhotos.size;
            selectionInfo.style.display = count > 0 ? 'inline' : 'none';
            selectionInfo.textContent = `${count} –≤—ã–±—Ä–∞–Ω–æ`;
            deleteBtn.style.display = count > 0 ? 'inline-block' : 'none';
        }

        function updateAssignButton() {
            // Can assign if:
            // 1. We have selected coordinates
            // 2. Either: in select mode with photos selected, OR not in select mode with folder selected
            const hasCoords = selectedCoords !== null;
            const hasSelection = (selectedFolder && selectedFolderCount > 0) || selectedPhotos.size > 0;

            assignBtn.disabled = !hasCoords || !hasSelection;

            if (selectedPhotos.size > 0) {
                assignBtn.textContent = `–ü—Ä–∏–≤—è–∑–∞—Ç—å ${selectedPhotos.size} —Ñ–æ—Ç–æ`;
            } else if (selectedFolderCount > 0) {
                assignBtn.textContent = `–ü—Ä–∏–≤—è–∑–∞—Ç—å –≤—Å–µ ${selectedFolderCount} —Ñ–æ—Ç–æ`;
            } else {
                assignBtn.textContent = '–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã';
            }

            // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–≤—è–∑–∞—Ç—å –≤–∏–¥–∏–º—ã–µ"
            const hasVisiblePhotos = currentFilteredPhotos && currentFilteredPhotos.length > 0;
            assignVisibleBtn.disabled = !hasCoords || !hasVisiblePhotos || selectMode;
            
            if (hasVisiblePhotos && currentFilteredPhotos.length > 0) {
                assignVisibleBtn.textContent = `–ü—Ä–∏–≤—è–∑–∞—Ç—å –≤–∏–¥–∏–º—ã–µ (${currentFilteredPhotos.length})`;
            } else {
                assignVisibleBtn.textContent = '–ü—Ä–∏–≤—è–∑–∞—Ç—å –≤–∏–¥–∏–º—ã–µ';
            }
        }

        // Assign coordinates
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–ü—Ä–∏–≤—è–∑–∞—Ç—å –≤–∏–¥–∏–º—ã–µ"
        assignVisibleBtn.addEventListener('click', async () => {
            if (!selectedCoords) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ', true);
                return;
            }

            if (!currentFilteredPhotos || currentFilteredPhotos.length === 0) {
                showToast('–ù–µ—Ç –≤–∏–¥–∏–º—ã—Ö —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏', true);
                return;
            }

            const visibleImageIds = currentFilteredPhotos.map(photo => photo.image_id);

            const payload = {
                latitude: selectedCoords.lat,
                longitude: selectedCoords.lng,
                image_ids: visibleImageIds
            };

            assignVisibleBtn.disabled = true;
            assignVisibleBtn.textContent = '–ü—Ä–∏–≤—è–∑–∫–∞...';

            try {
                const response = await fetch('/geo/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`–ü—Ä–∏–≤—è–∑–∞–Ω–æ ${data.updated} –≤–∏–¥–∏–º—ã—Ö —Ñ–æ—Ç–æ`);

                    // Reload data
                    await loadStats();
                    await loadFolders();

                    // Clear selection
                    selectedPhotos.clear();
                    photos = [];
                    currentFilteredPhotos = [];
                    selectedFolder = null;
                    updateSelectionInfo();

                    // Hide photo info
                    document.getElementById('photoInfoHeader').classList.remove('visible');

                    photosGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">‚úÖ</div>
                            –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –ø–∞–ø–∫—É
                        </div>
                    `;
                    document.getElementById('photoCount').textContent = '(0)';
                } else {
                    showToast(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏', true);
                }
            } catch (error) {
                console.error('Error assigning coordinates:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç', true);
            } finally {
                assignVisibleBtn.disabled = false;
                updateAssignButton();
            }
        });

        assignBtn.addEventListener('click', async () => {
            if (!selectedCoords) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ', true);
                return;
            }

            // Build payload
            const payload = {
                latitude: selectedCoords.lat,
                longitude: selectedCoords.lng
            };

            if (selectMode && selectedPhotos.size > 0) {
                payload.image_ids = Array.from(selectedPhotos);
            } else if (selectedFolder) {
                payload.folder = selectedFolder;
                if (selectedFormats && selectedFormats.length > 0) {
                    payload.formats = selectedFormats;
                }
            } else {
                showToast('–ù–µ—Ç —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏', true);
                return;
            }

            assignBtn.disabled = true;
            assignBtn.textContent = '–ü—Ä–∏–≤—è–∑–∫–∞...';

            try {
                const response = await fetch('/geo/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`–ü—Ä–∏–≤—è–∑–∞–Ω–æ ${data.updated} —Ñ–æ—Ç–æ`);

                    // Reload data
                    await loadStats();
                    await loadFolders();

                    // Clear selection
                    selectedPhotos.clear();
                    photos = [];
                    selectedFolder = null;
                    updateSelectionInfo();

                    // Hide photo info
                    document.getElementById('photoInfoHeader').classList.remove('visible');

                    photosGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">‚úÖ</div>
                            –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –ø–∞–ø–∫—É
                        </div>
                    `;
                    document.getElementById('photoCount').textContent = '(0)';
                } else {
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏', true);
                }
            } catch (error) {
                console.error('Error assigning GPS:', error);
                showToast('–û—à–∏–±–∫–∞: ' + error.message, true);
            }

            updateAssignButton();
        });

        // Delete button - show confirm dialog
        deleteBtn.addEventListener('click', () => {
            confirmText.textContent = `${selectedPhotos.size} —Ñ–∞–π–ª(–æ–≤) –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É.`;
            confirmDialog.classList.add('active');
        });

        // Confirm cancel
        confirmCancel.addEventListener('click', () => {
            confirmDialog.classList.remove('active');
        });

        // Confirm delete
        confirmDelete.addEventListener('click', async () => {
            confirmDialog.classList.remove('active');

            // Convert IDs to strings as API expects List[str]
            const imageIds = [...selectedPhotos].map(id => String(id));
            console.log('Deleting image IDs:', imageIds);
            deleteBtn.disabled = true;
            deleteBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';

            try {
                const response = await fetch('/photos/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_ids: imageIds })
                });

                console.log('Delete response status:', response.status);
                const result = await response.json();
                console.log('Delete result:', result);

                // Check if response is OK (2xx status)
                if (!response.ok) {
                    // Handle validation errors (422) or other HTTP errors
                    let errorMsg = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
                    
                    if (result.detail) {
                        if (Array.isArray(result.detail)) {
                            // Pydantic validation errors
                            errorMsg = result.detail.map(e => e.msg || JSON.stringify(e)).join(', ');
                        } else if (typeof result.detail === 'string') {
                            errorMsg = result.detail;
                        } else {
                            errorMsg = JSON.stringify(result.detail);
                        }
                    } else if (result.message) {
                        errorMsg = result.message;
                    }
                    
                    console.error('Server error:', errorMsg);
                    showToast(`–û—à–∏–±–∫–∞ ${response.status}: ${errorMsg}`, true);
                    return;
                }

                if (result.deleted > 0) {
                    showToast(`–£–¥–∞–ª–µ–Ω–æ: ${result.deleted} —Ñ–∞–π–ª(–æ–≤)`);

                    // Remove deleted items from photos array (ensure type matching)
                    const deletedIds = new Set([...selectedPhotos].map(id => Number(id)));
                    photos = photos.filter(p => !deletedIds.has(Number(p.image_id)));
                    
                    // Clear selection and exit select mode
                    selectedPhotos.clear();
                    selectMode = false;
                    selectBtn.classList.remove('active');
                    selectBtn.textContent = '–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ';
                    photosGrid.parentElement.classList.remove('select-mode');
                    
                    // Render updated photos
                    renderPhotos();
                    updateSelectionInfo();

                    // Update stats and folders
                    await loadStats();
                    await loadFolders();

                    // Hide photo info
                    document.getElementById('photoInfoHeader').classList.remove('visible');

                    // If folder is now empty or not selected, show empty state
                    if (photos.length === 0) {
                        photosGrid.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">‚úÖ</div>
                                –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –ø–∞–ø–∫—É
                            </div>
                        `;
                        document.getElementById('photoCount').textContent = '(0)';
                        selectedFolder = null;
                    }
                } else {
                    // No files deleted
                    showToast(`–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã`, true);
                    console.error('No files were deleted. Result:', result);
                }

                if (result.errors && result.errors.length > 0) {
                    console.error('Delete errors:', result.errors);
                    showToast(`–û—à–∏–±–∫–∏: ${result.errors.join('; ')}`, true);
                }

            } catch (error) {
                console.error('Delete error:', error);
                showToast(`–û—à–∏–±–∫–∞: ${error.message}`, true);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            }
        });

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize
        initFilters();
        loadStats();
        loadFolders();

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && confirmDialog.classList.contains('active')) {
                confirmDialog.classList.remove('active');
            }
        });
    </script>
</body>
</html>
