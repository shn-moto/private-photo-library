# КРИТИЧЕСКАЯ ПРОБЛЕМА: Потеря файлов при перемещении в trash

## Что произошло

При первом вызове `/photos/move-to-trash` 10 файлов были **физически перемещены** с помощью `shutil.move()`, но оказались потеряны.

## Причина

`shutil.move()` - это **физическая операция перемещения файла** на уровне ФС.

Если `TRASH_DIR` не был правильно замаплен в docker-compose.yml:
1. Файлы перемещались в `/.trash` **внутри контейнера**
2. Эта папка находилась в **ephemeral storage** контейнера
3. При любой операции с контейнером (перезапуск, пересборка) - **данные терялись**

## Сценарий потери данных

```
1. Пользователь вызывает API /photos/move-to-trash
2. Код находит 10 файлов
3. shutil.move() перемещает их в /.trash (внутри контейнера, не замапленную)
4. API возвращает success: {"moved": 10, "found": 10}
5. Файлы физически удалены из /photos
6. Файлы находятся в /.trash внутри контейнера
7. Контейнер перезапускается или volume не был правильно настроен
8. ❌ Файлы потеряны навсегда
```

## Решение

Добавлены **критические проверки безопасности** перед любым перемещением:

### 1. Проверка в начале эндпоинта
```python
if not os.path.exists(settings.TRASH_DIR):
    raise HTTPException(
        status_code=500, 
        detail=f"TRASH_DIR не существует или не замаплен: {settings.TRASH_DIR}. "
               f"Файлы НЕ будут перемещены для безопасности!"
    )
```

### 2. Проверка перед каждым перемещением
```python
if not os.path.exists(trash_dir):
    raise Exception(f"TRASH_DIR не существует или не замаплен: {trash_dir}")

if not os.access(trash_dir, os.W_OK):
    raise Exception(f"TRASH_DIR не доступен для записи: {trash_dir}")
```

### 3. Аналогичные проверки в duplicate_finder.py

## Как предотвратить в будущем

### ✅ ПЕРЕД запуском API убедитесь:

1. **Volume mapping настроен в docker-compose.yml:**
```yaml
volumes:
  - ${PHOTOS_HOST_PATH}/../.trash:/.trash
  - ${PHOTOS_HOST_PATH}/../.photo_duplicates:/.photo_duplicates
```

2. **Папки созданы на хосте:**
```bash
mkdir -p "D:/.trash"
mkdir -p "D:/.photo_duplicates"
```

3. **Проверка доступности внутри контейнера:**
```bash
docker exec smart_photo_api sh -c "test -d /.trash && echo OK || echo ERROR"
docker exec smart_photo_api sh -c "test -w /.trash && echo OK || echo ERROR"
```

4. **Тестовый запуск с маленьким top_k:**
```bash
# Сначала тест с 1 файлом
curl -X POST "http://localhost:8000/photos/move-to-trash" \
  -H "Content-Type: application/json" \
  -d '{"query": "test", "top_k": 1}'

# Проверить что файл появился на хосте
ls -la "D:/.trash/"
```

## Восстановление потерянных файлов

К сожалению, если файлы были перемещены в unmapped volume и контейнер был перезапущен - **данные утеряны безвозвратно**.

Возможные варианты:
1. Проверить backup системы
2. Проверить корзину Windows (если файлы удалялись через UI)
3. Использовать инструменты восстановления данных
4. Восстановить из резервных копий фотографий

## Текущее состояние

✅ Код исправлен с защитой от потери данных
✅ Проверки добавлены во все критические точки
✅ API вернет ошибку 500 если TRASH_DIR не доступен
✅ Перемещение не начнется если условия небезопасны

⚠️ **ОБЯЗАТЕЛЬНО перезапустите контейнеры после изменений!**
