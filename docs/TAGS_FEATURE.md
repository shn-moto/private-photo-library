# Tags & Hidden Photos ‚Äî Feature Documentation

## Overview

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–æ–≤ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å –¥–≤—É–º—è —Ü–µ–ª—è–º–∏:
1. **–ü–æ–∏—Å–∫** ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤—ã–¥–∞—á–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Ç–µ–≥–∞–º
2. **–°–∫—Ä—ã—Ç–∏–µ** ‚Äî —Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–µ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞—é—Ç —Ñ–æ—Ç–æ –∏–∑ –≤—Å–µ—Ö –≤—ã–±–æ—Ä–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## System Tags (—Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–µ–≥–∏)

| –¢–µ–≥ | –¶–≤–µ—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----|------|-----------|
| `private` | —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π `#8b5cf6` | –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ñ–æ—Ç–æ, –Ω–µ –¥–ª—è –æ–±—â–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ |
| `trash` | –∫—Ä–∞—Å–Ω—ã–π `#ef4444` | –ü–æ–º–µ—á–µ–Ω–æ –∫ —É–¥–∞–ª–µ–Ω–∏—é (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ TRASH_DIR) |
| `document` | –∂—ë–ª—Ç—ã–π `#f59e0b` | –î–æ–∫—É–º–µ–Ω—Ç—ã, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, —Ä–∞–±–æ—á–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã |

**–ü—Ä–∞–≤–∏–ª–∞:**
- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ–≥–∏ –≤–∏–¥–Ω—ã –∏ —É–ø—Ä–∞–≤–ª—è–µ–º—ã **—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º**
- –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–µ–≥–∏
- –§–æ—Ç–æ —Å–æ —Å–ª—É–∂–µ–±–Ω—ã–º —Ç–µ–≥–æ–º —Å–∫—Ä—ã—Ç—ã –∏–∑ **–≤—Å–µ—Ö** –≤—ã–±–æ—Ä–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- `trash` —Ç–µ–≥ **–Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç** –º–µ—Ö–∞–Ω–∏–∑–º `/photos/delete` (—Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤) ‚Äî –æ–±–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã

## Hidden Photos Logic

### –§–ª–∞–≥ `is_hidden`

–î–æ–±–∞–≤–ª–µ–Ω –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü `is_hidden BOOLEAN NOT NULL DEFAULT FALSE` –≤ —Ç–∞–±–ª–∏—Ü—É `photo_index`.

- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `TRUE` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç–µ–≥–∞
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ `FALSE` –∫–æ–≥–¥–∞ –≤—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ–≥–∏ —É–¥–∞–ª–µ–Ω—ã
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π `AND NOT is_hidden` –≤–º–µ—Å—Ç–æ JOIN –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

### –ì–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ñ–∏–ª—å—Ç—Ä

| Endpoint | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|----------|-----------|
| `POST /search/text` | –°–∫—Ä—ã–≤–∞–µ—Ç `is_hidden=TRUE` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ü–∞—Ä–∞–º–µ—Ç—Ä `include_hidden=true` —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ |
| `GET /timeline/photos` | –í—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ—Ç |
| `POST /map/clusters`, `GET /map/photos` | –í—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ—Ç |
| `GET /albums/{id}/photos` | –ü—É–±–ª–∏—á–Ω—ã–π –∞–ª—å–±–æ–º ‚Äî —Å–∫—Ä—ã–≤–∞–µ—Ç; –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∞–ª—å–±–æ–º (is_public=False) ‚Äî **–Ω–µ —Å–∫—Ä—ã–≤–∞–µ—Ç** |
| `GET /files/unindexed`, `/reindex/*` | –ù–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ (–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è) |

### –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∞–ª—å–±–æ–º—ã

–ï—Å–ª–∏ —Ñ–æ—Ç–æ —Å–æ —Å–ª—É–∂–µ–±–Ω—ã–º —Ç–µ–≥–æ–º –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ **–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∞–ª—å–±–æ–º** (is_public=False), –æ–Ω–æ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –≤–∏–¥–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –∞–ª—å–±–æ–º–∞ ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–µ–≥ –Ω–µ –º–µ—à–∞–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä—É –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ.

–í **–ø—É–±–ª–∏—á–Ω–æ–º –∞–ª—å–±–æ–º–µ** —Å–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ç–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–ª—è –Ω–µ-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.

## Database Schema

```sql
-- –¢–∞–±–ª–∏—Ü–∞ —Ç–µ–≥–æ–≤
CREATE TABLE tag (
    tag_id SERIAL PRIMARY KEY,
    name VARCHAR(64) NOT NULL UNIQUE,
    is_system BOOLEAN NOT NULL DEFAULT FALSE,
    color VARCHAR(7) NOT NULL DEFAULT '#6b7280',
    created_at TIMESTAMP DEFAULT NOW()
);

-- –°–≤—è–∑—å —Ñ–æ—Ç–æ ‚Üî —Ç–µ–≥–∏ (many-to-many)
CREATE TABLE photo_tag (
    image_id INTEGER NOT NULL REFERENCES photo_index(image_id) ON DELETE CASCADE,
    tag_id INTEGER NOT NULL REFERENCES tag(tag_id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (image_id, tag_id)
);

-- –§–ª–∞–≥ —Å–∫—Ä—ã—Ç–æ—Å—Ç–∏ –Ω–∞ photo_index
ALTER TABLE photo_index ADD COLUMN is_hidden BOOLEAN NOT NULL DEFAULT FALSE;
```

–ü—Ä–∏–º–µ–Ω–∏—Ç—å: `psql -U dev -d smart_photo_index -f sql/migrate_add_tags.sql`

## API Endpoints

### Tag CRUD

```
GET    /tags                    # —Å–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤
                                # –¢—É–Ω–Ω–µ–ª—å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ is_system=FALSE
                                # –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ —Ç–µ–≥–∏
POST   /tags                    # —Å–æ–∑–¥–∞—Ç—å —Ç–µ–≥ (admin only)
                                # Body: {"name": "vacation", "color": "#22d3ee"}
DELETE /tags/{tag_id}           # —É–¥–∞–ª–∏—Ç—å —Ç–µ–≥ (admin only, –Ω–µ–ª—å–∑—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ)
```

### Photo Tags

```
GET    /photo/{image_id}/tags   # –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–≥–∏ —Ñ–æ—Ç–æ
                                # Response: [{tag_id, name, is_system, color}, ...]

POST   /photo/{image_id}/tags   # –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏ –∫ —Ñ–æ—Ç–æ
                                # Body: {"tag_ids": [1, 2, 3]}
                                # –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ–≥–∏: —Ç–æ–ª—å–∫–æ –¥–ª—è admin

DELETE /photo/{image_id}/tags   # —É–±—Ä–∞—Ç—å —Ç–µ–≥–∏ —Å —Ñ–æ—Ç–æ
                                # Body: {"tag_ids": [1, 2, 3]}
                                # –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ–≥–∏: —Ç–æ–ª—å–∫–æ –¥–ª—è admin
                                # –û–±–Ω–æ–≤–ª—è–µ—Ç is_hidden –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

POST   /photos/tags/bulk        # –ø–∞–∫–µ—Ç–Ω–æ–µ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                                # Body: {"image_ids": [1,2,3], "tag_ids": [1,2], "mode": "add"|"remove"}
```

### Search with Tags

```
POST /search/text
Body:
{
  "query": "sunset",
  "tag_ids": [5, 6],       // AND-–ª–æ–≥–∏–∫–∞: —Ñ–æ—Ç–æ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –í–°–ï —Ç–µ–≥–∏
  "include_hidden": false  // admin only: –ø–æ–∫–∞–∑–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ç–æ
}
```

## Frontend

### Tag Filter (Desktop)

–í —Ç—É–ª–±–∞—Ä–µ –ø–æ–∏—Å–∫–∞ (—Ä—è–¥–æ–º —Å person selector) ‚Äî –∫–Ω–æ–ø–∫–∞ "üè∑ –¢–µ–≥–∏":
- –î—Ä–æ–ø–¥–∞—É–Ω —Å —Ü–≤–µ—Ç–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–≥–∞
- –ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä (AND-–ª–æ–≥–∏–∫–∞)
- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ —Ü–≤–µ—Ç–Ω—ã–µ —á–∏–ø—ã-–ø–∏–ª—é–ª–∏
- –£ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–µ–≥–∏
- –£ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚Äî –≤—Å–µ —Ç–µ–≥–∏ (—Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–º–µ—á–µ–Ω—ã üîí)

### Tag Filter (Mobile)

–ö–Ω–æ–ø–∫–∞ üéöÔ∏è –≤ —Ç—É–ª–±–∞—Ä–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ–∫–æ–≤—É—é –≤—ã–µ–∑–∂–∞—é—â—É—é –ø–∞–Ω–µ–ª—å —Å–ª–µ–≤–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, –≤–∫–ª—é—á–∞—è —Ç–µ–≥-—Ñ–∏–ª—å—Ç—Ä.

### Lightbox ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏

–í —Å–≤–µ—Ç–ª–æ–º –±–ª–æ–∫–µ –Ω–∞–¥ –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π ‚Äî —Å—Ç—Ä–æ–∫–∞ —Ç–µ–≥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–æ—Ç–æ:
- –¶–≤–µ—Ç–Ω—ã–µ –ø–∏–ª—é–ª–∏ —Å –∫—Ä–µ—Å—Ç–∏–∫–æ–º –¥–ª—è —Å–Ω—è—Ç–∏—è —Ç–µ–≥–∞
- –ö–Ω–æ–ø–∫–∞ "+" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥—Ä–æ–ø–¥–∞—É–Ω –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞
- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ–≥–∏ –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã

### Selection Bar ‚Äî –ø–∞–∫–µ—Ç–Ω–æ–µ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ö–Ω–æ–ø–∫–∞ üè∑ –≤ –±–∞—Ä–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è (—Ä—è–¥–æ–º —Å "–í –∞–ª—å–±–æ–º"):
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω—ã–π —Ç–µ–≥-–ø–∏–∫–µ—Ä
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏ –∫–æ –≤—Å–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º —Ñ–æ—Ç–æ

## Component: TagFilter

–§–∞–π–ª: `api/static/tag_filter.js`

```javascript
const tagFilter = new TagFilter(container, {
    isAdmin: true,       // –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ–≥–∏
    onChanged: () => {}  // callback –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞
});

tagFilter.getSelectedIds();  // ‚Üí [1, 3, 5]
tagFilter.clearSelection();
```

–ü–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É `person_selector.js` ‚Äî –∫–Ω–æ–ø–∫–∞ + –¥—Ä–æ–ø–¥–∞—É–Ω + —á–∏–ø—ã.

## Implementation Notes

- `is_hidden` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `_sync_is_hidden(db, image_id)` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–≥–æ–≤
- SQL –∏–Ω—ä–µ–∫—Ü–∏–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã: `tag_id` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `int()` –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ
- `include_hidden=true` –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –Ω–µ-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ `is_admin` –∏–∑ —Å–µ—Å—Å–∏–∏)
- –ò–Ω–¥–µ–∫—Å `WHERE is_hidden = TRUE` ‚Äî —á–∞—Å—Ç–∏—á–Ω—ã–π, –Ω–µ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
